{% extends "universe/base.html" %}
{% block content %}
<h2>{{ auction.artefact.name }}</h2>
<p>Ends: <span id="end-time">{{ auction.end_time }}</span></p>
<p>Current price: <span id="current-price">{{ current_price|default:0 }}</span></p>
<p>Highest bidder: 
{% if highest %}
    {{ highest.bidder.username }}
{% else %}
    No bids yet
{% endif %}
</p>

{% if user.is_authenticated %}
  <form id="bid-form">
    {% csrf_token %}
    <input type="number" step="0.01" id="bid-amount" placeholder="Your bid">
    <button id="place-bid" type="submit" class="btn btn-primary">Place bid</button>
  </form>
{% else %}
  <p><a href="{% url 'login' %}">Login</a> to bid.</p>
{% endif %}

<script>
const auctionId = "{{ auction.auction_id|default:'null' }}";
const currentUser = "{% if user.is_authenticated %}{{ user.username|escapejs }}{% else %}null{% endif %}";
const endTime = new Date("{{ auction.end_time|date:'c'|default:'' }}").getTime();

async function getCurrent() {
  const res = await fetch(`/auctions/${auctionId}/current/`);
  const data = await res.json();
  document.getElementById('current-price').innerText = data.current || 0;
  document.getElementById('highest-bidder').innerText = data.highest_bidder || "No bids yet";
  return data;
}

// Poll every 3 seconds
const pollInterval = setInterval(async () => {
  const data = await getCurrent();
  const now = Date.now();
  if (now >= endTime || data.ended) {
    clearInterval(pollInterval);
    if (data.highest_bidder && data.highest_bidder === currentUser) {
      const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const res = await fetch(`/auctions/${auctionId}/finalize/`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrf},
      });
      const json = await res.json();
      if (json.success && json.redirect_url) {
        alert("Congratulations â€” you won this auction! Redirecting to your order.");
        window.location = json.redirect_url;
      } else {
        alert(json.message || json.error || "Auction ended.");
      }
    } else {
      alert("Auction ended.");
      window.location.reload();
    }
  }
}, 3000);

// Place bid
document.getElementById('bid-form')?.addEventListener('submit', async e => {
  e.preventDefault();
  const amount = document.getElementById('bid-amount').value;
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const res = await fetch(`/auctions/${auctionId}/place_bid/`, {
    method: 'POST',
    headers: {'X-CSRFToken': csrf, 'Content-Type': 'application/x-www-form-urlencoded'},
    body: `amount=${encodeURIComponent(amount)}`
  });
  const json = await res.json();
  if (json.success) {
    alert('Bid placed!');
    getCurrent();
  } else {
    alert(json.error || 'Bid failed');
  }
});
</script>
{% endblock %}
