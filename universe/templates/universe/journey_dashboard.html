{% extends 'universe/base.html' %}

{% block content %}
<div class="card p-4">
    <h3>Journey Dashboard</h3>

    <!-- Search form -->
    <form method="GET" class="mb-3">
        <input type="text" name="q" placeholder="Search by username" class="form-control" value="{{ request.GET.q }}">
        <button type="submit" class="btn btn-portal mt-2">Search</button>
    </form>

    <!-- Most visited universe -->
    {% if most_visited %}
        <p><strong>Most visited universe:</strong> {{ most_visited.universe__name }} ({{ most_visited.visits }} visits)</p>
    {% endif %}

    <!-- Recent 3-day travel counts -->
    {% if recent_counts %}
        <p><strong>Travel counts in last 3 days:</strong></p>
        <ul>
            {% for item in recent_counts %}
                <li>{{ item.user__username }}: {{ item.travel_count }} travels</li>
            {% endfor %}
        </ul>
    {% endif %}

    <!-- Journey logs table -->
    <table class="table table-dark table-striped mt-3">
        <thead>
            <tr>
                <th>User</th>
                <th>Universe</th>
                <th>Date</th>
                <th>Success</th>
                <th>Manual Entry</th>
                <th>Points</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.user.username }}</td>
                <td>{{ log.universe.name }}</td>
                <td>{{ log.travel_date|date:"Y-m-d H:i" }}</td>
                <td>{{ log.success|yesno:"Yes,No" }}</td>
                <td>{{ log.manual_entry|yesno:"Yes,No" }}</td>
                <td>{{ log.points_awarded }}</td>
                <td>
                    <a href="{% url 'edit_journey' log.pk %}" class="btn btn-travel btn-sm">Edit</a>
                    <a href="{% url 'delete_journey' log.pk %}" class="btn btn-danger btn-sm">Delete</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7">No journeys found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<!-- Auto-refresh every 10 seconds -->
<script>
    setInterval(function() {
        fetch("{% url 'journey_dashboard' %}?ajax=1")
        .then(response => response.text())
        .then(html => {
            let tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            let newTbody = tempDiv.querySelector('tbody');
            let oldTbody = document.querySelector('table tbody');
            if(newTbody && oldTbody){
                oldTbody.innerHTML = newTbody.innerHTML;
            }
        });
    }, 10000);
</script>
{% endblock %}
